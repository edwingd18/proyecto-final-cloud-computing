version: '3.8'

services:
  # PostgreSQL para el servicio de activos
  postgres:
    image: postgres:15-alpine
    container_name: postgres-activos
    environment:
      POSTGRES_DB: activos_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres123
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MongoDB para el servicio de mantenimientos
  mongodb:
    image: mongo:7
    container_name: mongodb-mantenimientos
    environment:
      MONGO_INITDB_DATABASE: mantenimientos_db
    ports:
      - "27018:27017"
    volumes:
      - mongodb_data:/data/db
    networks:
      - microservices-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  # Servicio de Activos (Node.js + PostgreSQL)
  servicio-activos:
    build:
      context: ./servicio-activos
      dockerfile: Dockerfile
    container_name: servicio-activos
    environment:
      PORT: 3001
      NODE_ENV: production
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: activos_db
      DB_USER: postgres
      DB_PASSWORD: postgres123
    ports:
      - "3001:3001"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - microservices-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Servicio de Mantenimientos (Node.js + MongoDB)
  servicio-mantenimientos:
    build:
      context: ./servicio-mantenimientos
      dockerfile: Dockerfile
    container_name: servicio-mantenimientos
    environment:
      PORT: 3002
      NODE_ENV: production
      MONGO_URI: mongodb://mongodb:27017/mantenimientos_db
    ports:
      - "3002:3002"
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - microservices-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # API Gateway
  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: api-gateway
    environment:
      PORT: 3000
      NODE_ENV: production
      ACTIVOS_SERVICE_URL: http://servicio-activos:3001
      MANTENIMIENTOS_SERVICE_URL: http://servicio-mantenimientos:3002
    ports:
      - "3000:3000"
    depends_on:
      servicio-activos:
        condition: service_healthy
      servicio-mantenimientos:
        condition: service_healthy
    networks:
      - microservices-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Frontend (Next.js)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: http://localhost:3000/api
    ports:
      - "3003:3003"
    depends_on:
      api-gateway:
        condition: service_healthy
    networks:
      - microservices-network
    restart: unless-stopped

  # Jenkins para CI/CD
  jenkins:
    build:
      context: .
      dockerfile: jenkins.Dockerfile
    container_name: jenkins
    user: root
    environment:
      - JENKINS_OPTS=--prefix=/jenkins
      - DOCKER_HOST=unix:///var/run/docker.sock
    ports:
      - "8080:8080"
      - "50000:50000"
    volumes:
      - jenkins_home:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - microservices-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/jenkins/login || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

networks:
  microservices-network:
    driver: bridge
    name: microservices-network

volumes:
  postgres_data:
    name: postgres-activos-data
  mongodb_data:
    name: mongodb-mantenimientos-data
  jenkins_home:
    name: jenkins-home-data
